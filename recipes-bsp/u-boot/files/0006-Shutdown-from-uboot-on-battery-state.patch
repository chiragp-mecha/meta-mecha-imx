From e37aa4785eab4d2e186cdb06be886981b024a13e Mon Sep 17 00:00:00 2001
From: chiragp-mechas <chiragp@mechasystems.com>
Date: Thu, 28 Dec 2023 16:50:11 +0530
Subject: [PATCH] Shutdown-from-uboot-on-battery-state

---
 board/freescale/imx8mm_evk/imx8mm_evk.c | 36 ++++++++++++++++++++++---
 1 file changed, 33 insertions(+), 3 deletions(-)

diff --git a/board/freescale/imx8mm_evk/imx8mm_evk.c b/board/freescale/imx8mm_evk/imx8mm_evk.c
index a4a546c667..e3e71322db 100644
--- a/board/freescale/imx8mm_evk/imx8mm_evk.c
+++ b/board/freescale/imx8mm_evk/imx8mm_evk.c
@@ -21,6 +21,10 @@
 #include "../common/tcpc.h"
 #include <usb.h>
 #include <power/bq27xxx_fg.h>
+#include <imx_sip.h>
+#include <linux/arm-smccc.h>
+#include <splash.h>
+#define DEVICE_SHUTDOWN_BATTERY_PERCENT 5
 
 DECLARE_GLOBAL_DATA_PTR;
 
@@ -168,7 +172,7 @@ int power_fg_i2c_init_update(uint8_t i2c_bus, uint8_t addr)
 	}
 	power_fg_init_update(i2c_bus, i2c_dev);
 
-	return 0;
+	return power_fg_init_update(i2c_bus, i2c_dev);
 }
 
 static int setup_pd_switch(uint8_t i2c_bus, uint8_t addr)
@@ -340,26 +344,52 @@ int board_ehci_usb_phy_mode(struct udevice *dev)
 }
 
 #endif
-
+#define DISPMIX				9
+#define MIPI				10
+bool is_battery_low = false;
 int board_init(void)
 {
+	struct arm_smccc_res res;
 #ifdef CONFIG_USB_TCPC
 	setup_typec();
 #endif
 
 	if (IS_ENABLED(CONFIG_FEC_MXC))
 		setup_fec();
+	if (!(power_fg_i2c_init_update(2, 0x55) < 0)) {
+		bq27xxx_battery *bat;
+		power_read_battery_property(bat);
+		printf("battery : percentage %d\n", bat->soc);
+		if (bat->soc < DEVICE_SHUTDOWN_BATTERY_PERCENT && bat->supply_status != POWER_SUPPLY_STATUS_CHARGING) {
+			is_battery_low = true;
+			printf("battery: lower then 5 percentage and charger is not connected\n");
+			arm_smccc_smc(IMX_SIP_GPC, IMX_SIP_GPC_PM_DOMAIN, DISPMIX, true, 0, 0, 0, 0, &res);
+			arm_smccc_smc(IMX_SIP_GPC, IMX_SIP_GPC_PM_DOMAIN, MIPI, true, 0, 0, 0, 0, &res);
+		} else {
+			arm_smccc_smc(IMX_SIP_GPC, IMX_SIP_GPC_PM_DOMAIN, DISPMIX, true, 0, 0, 0, 0, &res);
+			arm_smccc_smc(IMX_SIP_GPC, IMX_SIP_GPC_PM_DOMAIN, MIPI, false, 0, 0, 0, 0, &res);
+		}
+	} else {
+		arm_smccc_smc(IMX_SIP_GPC, IMX_SIP_GPC_PM_DOMAIN, DISPMIX, true, 0, 0, 0, 0, &res);
+		arm_smccc_smc(IMX_SIP_GPC, IMX_SIP_GPC_PM_DOMAIN, MIPI, false, 0, 0, 0, 0, &res);
+	}
 
 	return 0;
 }
 
 int board_late_init(void)
 {
+	if (is_battery_low) { run_command("mmc dev 2", 0); run_command("mmc rescan", 0);
+		run_command("load mmc 2 ${loadaddr} low_battery.bmp", 0);
+		run_command("bmp display ${loadaddr}", 0);
+		printf("powering down in 10 seconds\n");
+		mdelay(10000);
+		memset(0x30370038, 0x60, 1);
+	} else {run_command("mmc dev 2", 0); run_command("mmc rescan", 0);run_command("load mmc 2 ${loadaddr} logo.bmp", 0);run_command("bmp display ${loadaddr}", 0);}
 #ifdef CONFIG_ENV_IS_IN_MMC
 	board_late_mmc_env_init();
 #endif
 
-	power_fg_i2c_init_update(2, 0x55);
 	if (IS_ENABLED(CONFIG_ENV_VARS_UBOOT_RUNTIME_CONFIG)) {
 		env_set("board_name", "EVK");
 		env_set("board_rev", "iMX8MM");
-- 
2.25.1

